<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="theme-color" content="#1a1410" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Weight Cut" />
    <title>WEIGHT CUT PLANNER</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,400;0,600;0,700;0,800;0,900;1,700;1,900&family=Barlow:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      :root {
        --cream: #f2ede6;
        --paper: #e8e0d5;
        --white: #faf7f3;
        --ink: #1a1410;
        --ink2: #4a3f35;
        --ink3: #8a7b6e;
        --red: #c0281a;
        --red-light: #f5d5d2;
        --olive: #5c6b3a;
        --olive-light: #dde5cc;
        --amber: #7a5c1a;
        --amber-light: #f5e8cc;
        --blue: #1a5a7a;
        --blue-light: #cce0ed;
        --border: #c8bfb2;
        --border-heavy: #9a8e82;
        --shadow: 4px 4px 0px #1a1410;
        --shadow-sm: 2px 2px 0px #1a1410;
      }
      body {
        font-family: "Barlow", sans-serif;
        background: var(--cream);
        color: var(--ink);
        min-height: 100vh;
        font-size: 14px;
        line-height: 1.5;
        background-image: repeating-linear-gradient(
          0deg,
          transparent,
          transparent 31px,
          rgba(180, 160, 140, 0.12) 31px,
          rgba(180, 160, 140, 0.12) 32px
        );
        touch-action: manipulation;
      }
      html,
      body {
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
      }
      button,
      input,
      select,
      .btn,
      .btn-small {
        touch-action: manipulation;
      }
      * {
        min-width: 0;
      }

      .header {
        background: var(--ink);
        position: relative;
        overflow: hidden;
      }
      .header-inner {
        padding: 36px 24px 32px;
        position: relative;
        z-index: 1;
        max-width: 880px;
        margin: 0 auto;
      }
      .header-stripe {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: repeating-linear-gradient(
          90deg,
          var(--red) 0px,
          var(--red) 32px,
          var(--ink) 32px,
          var(--ink) 40px
        );
      }
      .header-eyebrow {
        font-family: "Barlow Condensed", sans-serif;
        font-size: 11px;
        letter-spacing: 0.35em;
        text-transform: uppercase;
        color: var(--ink3);
        font-weight: 600;
        margin-bottom: 8px;
      }
      .header h1 {
        font-family: "Barlow Condensed", sans-serif;
        font-size: clamp(48px, 11vw, 96px);
        font-weight: 900;
        line-height: 0.88;
        text-transform: uppercase;
        color: var(--white);
      }
      .header h1 .accent {
        color: var(--red);
        font-style: italic;
      }
      .header-sub {
        color: var(--ink3);
        font-size: 13px;
        margin-top: 18px;
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }

      .container {
        max-width: 880px;
        margin: 0 auto;
        padding: 0 16px 80px;
        overflow-x: hidden;
        width: 100%;
      }

      .card {
        background: var(--white);
        border: 2px solid var(--ink);
        padding: 24px;
        margin-top: 20px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .card-title {
        font-family: "Barlow Condensed", sans-serif;
        font-size: 11px;
        letter-spacing: 0.25em;
        text-transform: uppercase;
        color: var(--red);
        font-weight: 700;
        margin-bottom: 20px;
      }

      .tabs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 18px;
      }
      .tab-btn {
        border: 2px solid var(--ink);
        background: var(--white);
        color: var(--ink2);
        padding: 10px 12px;
        font-family: "Barlow Condensed", sans-serif;
        font-size: 13px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        font-weight: 700;
        cursor: pointer;
      }
      .tab-btn.active {
        background: var(--ink);
        color: var(--white);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(min(220px, 100%), 1fr));
        gap: 16px;
      }
      .form-group {
        min-width: 0;
      }
      .form-group label {
        display: block;
        font-family: "Barlow Condensed", sans-serif;
        font-size: 10px;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: var(--ink2);
        font-weight: 700;
        margin-bottom: 6px;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        max-width: 100%;
        background: var(--cream);
        border: 2px solid var(--border-heavy);
        padding: 9px 11px;
        color: var(--ink);
        font-size: 14px;
        font-family: "Barlow", sans-serif;
        font-weight: 500;
        min-width: 0;
      }
      .form-group input[type="date"] {
        display: block;
        width: 100%;
        min-width: 0;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        -webkit-appearance: textfield;
        appearance: textfield;
        padding-right: 10px;
        font-size: 16px;
        width: -webkit-fill-available;
      }
      .form-group input[type="date"]::-webkit-date-and-time-value {
        text-align: left;
      }
      .form-group input[type="date"]::-webkit-calendar-picker-indicator {
        margin: 0;
        padding: 0;
      }
      input,
      select,
      button {
        max-width: 100%;
      }
      .field-help {
        margin-top: 5px;
        color: var(--ink3);
        font-size: 11px;
      }

      .btn {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        background: var(--red);
        color: var(--white);
        border: 2px solid var(--ink);
        padding: 12px 28px;
        font-family: "Barlow Condensed", sans-serif;
        font-size: 14px;
        font-weight: 800;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        cursor: pointer;
        box-shadow: var(--shadow-sm);
        margin-top: 20px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        margin-top: 20px;
        border: 2px solid var(--ink);
        box-shadow: var(--shadow);
      }
      .stat-card {
        background: var(--white);
        padding: 18px 16px;
        border-right: 2px solid var(--ink);
      }
      .stat-card:last-child {
        border-right: none;
      }
      .stat-label {
        font-family: "Barlow Condensed", sans-serif;
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: var(--ink3);
        font-weight: 700;
        margin-bottom: 6px;
      }
      .stat-value {
        font-family: "Barlow Condensed", sans-serif;
        font-size: 30px;
        font-weight: 900;
        line-height: 1;
      }
      .stat-unit {
        font-size: 12px;
        color: var(--ink3);
      }

      .risk-banner,
      .warn-box,
      .info-box,
      .rehyd-box,
      .water-box,
      .nutrition-box {
        border: 2px solid var(--ink);
        padding: 14px 18px;
        margin-top: 16px;
        background: var(--white);
        box-shadow: var(--shadow-sm);
      }
      .risk-tag {
        display: inline-block;
        font-family: "Barlow Condensed", sans-serif;
        font-size: 10px;
        font-weight: 800;
        letter-spacing: 0.15em;
        text-transform: uppercase;
        padding: 3px 8px;
        border: 1.5px solid currentColor;
        margin-bottom: 8px;
      }
      .warn-box {
        border-color: var(--red);
        background: var(--red-light);
        color: var(--red);
      }
      .info-box {
        border-color: var(--olive);
        background: var(--olive-light);
      }
      .rehyd-box {
        border-color: var(--olive);
        background: var(--olive-light);
      }
      .water-box {
        border-color: var(--blue);
        background: var(--blue-light);
      }
      .nutrition-box {
        border-color: var(--amber);
        background: var(--amber-light);
      }

      /* Water Loading Table */
      .water-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 13px;
      }
      .water-table th {
        font-family: "Barlow Condensed", sans-serif;
        font-size: 10px;
        letter-spacing: 0.15em;
        text-transform: uppercase;
        text-align: left;
        padding: 6px 10px;
        background: var(--blue);
        color: var(--white);
        font-weight: 700;
      }
      .water-table td {
        padding: 7px 10px;
        border-bottom: 1px solid rgba(26, 90, 122, 0.2);
      }
      .water-table tr:last-child td {
        border-bottom: none;
      }
      .water-table tr.highlight-row td {
        background: rgba(26, 90, 122, 0.12);
        font-weight: 600;
      }

      /* Nutrition Timeline */
      .nutrition-timeline {
        margin-top: 12px;
      }
      .nutrition-day-row {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        padding: 8px 12px;
        border-bottom: 1px solid rgba(122, 92, 26, 0.2);
      }
      .nutrition-day-row:last-child {
        border-bottom: none;
      }
      .nutrition-day-num {
        font-family: "Barlow Condensed", sans-serif;
        font-size: 22px;
        font-weight: 900;
        min-width: 36px;
        color: var(--amber);
      }
      .nutrition-day-content {
        flex: 1;
        font-size: 12px;
        color: var(--ink2);
      }
      .nutrition-tag {
        display: inline-block;
        font-family: "Barlow Condensed", sans-serif;
        font-size: 9px;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        padding: 2px 6px;
        border: 1px solid currentColor;
        margin-right: 4px;
        margin-bottom: 3px;
        font-weight: 700;
      }

      .timeline {
        margin-top: 16px;
      }
      .day-row {
        display: flex;
        gap: 16px;
        align-items: flex-start;
        background: var(--white);
        border: 1.5px solid var(--border);
        border-left: 4px solid var(--border-heavy);
        padding: 12px 16px;
        margin-bottom: 6px;
      }
      .day-date {
        min-width: 76px;
      }
      .day-content {
        min-width: 0;
        flex: 1;
      }
      .day-label {
        font-family: "Barlow Condensed", sans-serif;
        font-size: 9px;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: var(--ink3);
      }
      .day-weight {
        font-family: "Barlow Condensed", sans-serif;
        font-size: 24px;
        font-weight: 900;
      }
      .day-weight-unit {
        font-size: 11px;
        color: var(--ink3);
      }
      .day-phase-name {
        font-family: "Barlow Condensed", sans-serif;
        font-size: 13px;
        font-weight: 800;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        margin-bottom: 6px;
      }
      .day-tips {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }
      .tip-tag {
        font-size: 11px;
        font-weight: 500;
        background: var(--cream);
        border: 1px solid var(--border);
        padding: 2px 7px;
        color: var(--ink2);
      }
      .tip-tag.highlight {
        background: var(--red-light);
        border-color: var(--red);
        color: var(--red);
        font-weight: 600;
      }
      .tip-tag.blue {
        background: var(--blue-light);
        border-color: var(--blue);
        color: var(--blue);
      }
      .tip-tag.amber {
        background: var(--amber-light);
        border-color: var(--amber);
        color: var(--amber);
      }

      .disclaimer {
        border-top: 1px solid var(--border);
        margin-top: 32px;
        padding-top: 18px;
        text-align: center;
        font-size: 11px;
        color: var(--ink3);
      }

      .log-row {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        gap: 10px;
        align-items: end;
        margin-bottom: 14px;
      }
      .log-row .form-group {
        width: 100%;
        min-width: 0;
        overflow: hidden;
      }
      .log-row .btn {
        margin-top: 0;
        white-space: nowrap;
        grid-column: 1 / -1;
        width: 100%;
      }
      .log-list {
        border-top: 1px solid var(--border);
        margin-top: 8px;
      }
      .log-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border);
        padding: 8px 0;
        gap: 10px;
      }
      .log-meta {
        color: var(--ink2);
        font-size: 13px;
      }
      .log-weight {
        font-family: "Barlow Condensed", sans-serif;
        font-size: 24px;
        font-weight: 900;
        white-space: nowrap;
      }
      .log-actions {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 10px;
        min-width: 0;
        flex-wrap: wrap;
      }
      .btn-small {
        background: transparent;
        border: 1px solid var(--border-heavy);
        color: var(--ink2);
        padding: 6px 10px;
        cursor: pointer;
        font-size: 12px;
        flex-shrink: 0;
      }

      /* Calorie feasibility warning */
      .calorie-warn {
        border-color: var(--amber);
        background: var(--amber-light);
      }
      .calorie-warn .risk-tag {
        color: var(--amber);
      }

      @media (max-width: 820px) {
        .form-grid {
          grid-template-columns: 1fr 1fr;
        }
        .log-row {
          grid-template-columns: 1fr 1fr;
        }
        .stats-grid {
          grid-template-columns: 1fr 1fr;
        }
        .stat-card {
          border-right: none;
          border-bottom: 2px solid var(--ink);
        }
        .stat-card:nth-last-child(-n + 2) {
          border-bottom: none;
        }
        .header-inner {
          padding: 28px 16px 24px;
        }
        .header h1 {
          font-size: clamp(36px, 13vw, 72px);
          line-height: 0.92;
        }
      }
      @media (max-width: 640px) {
        .container {
          padding: 0 10px 40px;
        }
        .card {
          padding: 16px 12px;
          margin-top: 14px;
        }
        .form-grid {
          grid-template-columns: 1fr;
          gap: 12px;
        }
        .btn {
          width: 100%;
          padding: 12px 16px;
        }
        .tabs {
          position: sticky;
          top: 0;
          z-index: 20;
          background: var(--cream);
          padding-top: 8px;
        }
        .log-row {
          grid-template-columns: 1fr;
          align-items: stretch;
        }
        .log-row .form-group {
          width: 100%;
        }
        .log-row .btn {
          width: 100%;
        }
        .day-row {
          flex-direction: column;
          gap: 8px;
          padding: 10px 12px;
        }
        .day-date {
          min-width: 0;
        }
        .day-weight {
          font-size: 22px;
        }
        .tip-tag {
          white-space: normal;
        }
        .log-item {
          flex-direction: column;
          align-items: flex-start;
        }
        .log-item > div:last-child {
          width: 100%;
          justify-content: space-between;
        }
        .info-box,
        .warn-box,
        .risk-banner,
        .rehyd-box,
        .water-box,
        .nutrition-box {
          padding: 12px;
        }
        .water-table td,
        .water-table th {
          padding: 5px 7px;
        }
      }
      @media (max-width: 520px) {
        .stats-grid {
          grid-template-columns: 1fr 1fr;
        }
        .header-eyebrow {
          font-size: 10px;
          letter-spacing: 0.18em;
        }
        .header-sub {
          font-size: 11px;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-stripe"></div>
      <div class="header-inner">
        <div class="header-eyebrow">Combat Sports · Gewichtsmanagement</div>
        <h1>WEIGHT<br /><span class="accent">CUT</span><br />PLANNER</h1>
        <p class="header-sub">Taktische Planung. Präzise Ausführung.</p>
      </div>
    </div>

    <div class="container">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('planner', this)">
          Plan
        </button>
        <button class="tab-btn" onclick="switchTab('log', this)">
          Tagebuch
        </button>
      </div>

      <div id="tab-planner" class="tab-content active">
        <div class="card">
          <div class="card-title">Eingabe</div>
          <div class="form-grid">
            <div class="form-group">
              <label>Sportart</label>
              <select id="sport" onchange="onSportChange()">
                <option>BJJ / Grappling</option>
                <option>MMA</option>
                <option>Boxing</option>
                <option>Wrestling</option>
                <option>Kickboxing / Muay Thai</option>
                <option>Judo</option>
              </select>
            </div>
            <div class="form-group">
              <label>Gewichtsklasse</label>
              <select id="weightClass"></select>
            </div>
            <div class="form-group">
              <label>Eigenes Limit (kg, optional)</label>
              <input
                type="number"
                id="customLimit"
                placeholder="z.B. 77.1"
                step="0.1"
              />
              <div class="field-help">
                Überschreibt die gewählte Gewichtsklasse.
              </div>
            </div>
            <div class="form-group">
              <label>Aktuelles Gewicht (kg)</label>
              <input
                type="number"
                id="currentWeight"
                placeholder="z.B. 84.5"
                step="0.1"
              />
            </div>
            <div class="form-group">
              <label>Wettkampfdatum</label>
              <input type="date" id="fightDate" />
            </div>
            <div class="form-group">
              <label>Wiegemodus</label>
              <select id="weighInType">
                <option value="day_before">Tag vorher wiegen</option>
                <option value="same_day">Am Kampftag wiegen</option>
              </select>
            </div>
            <div class="form-group">
              <label>Erfahrung</label>
              <select id="experience">
                <option value="beginner">Anfänger (0–5 Weight Cuts)</option>
                <option value="intermediate" selected>
                  Intermediate (6–10 Weight Cuts)
                </option>
                <option value="advanced">Erfahren (über 10 Weight Cuts)</option>
              </select>
            </div>
          </div>
          <button class="btn" onclick="calculate()">Plan berechnen</button>
        </div>

        <div id="results"></div>
      </div>

      <div id="tab-log" class="tab-content">
        <div class="card">
          <div class="card-title">Gewichtstagebuch (Browser gespeichert)</div>
          <div class="log-row">
            <div class="form-group">
              <label>Datum</label>
              <input type="date" id="logDate" />
            </div>
            <div class="form-group">
              <label>Gewicht (kg)</label>
              <input
                type="number"
                id="logWeight"
                step="0.1"
                placeholder="z.B. 83.2"
              />
            </div>
            <button class="btn" onclick="saveDailyWeightEntry()">
              Speichern
            </button>
          </div>
          <div id="dailyWeightList" class="log-list"></div>
        </div>
      </div>
    </div>

    <script>
      const WEIGHT_CLASSES = {
        "BJJ / Grappling": [
          { name: "Rooster (-57,5 kg)", limit: 57.5 },
          { name: "Light-Feather (-64 kg)", limit: 64 },
          { name: "Feather (-70 kg)", limit: 70 },
          { name: "Light (-76 kg)", limit: 76 },
          { name: "Middle (-82,3 kg)", limit: 82.3 },
          { name: "Medium-Heavy (-88,3 kg)", limit: 88.3 },
          { name: "Heavy (-94,3 kg)", limit: 94.3 },
          { name: "Super-Heavy (-100,5 kg)", limit: 100.5 },
          { name: "Ultra-Heavy (+100,5 kg)", limit: 999 },
        ],
        MMA: [
          { name: "Strawweight (-52,2 kg)", limit: 52.2 },
          { name: "Flyweight (-56,7 kg)", limit: 56.7 },
          { name: "Bantamweight (-61,2 kg)", limit: 61.2 },
          { name: "Featherweight (-65,8 kg)", limit: 65.8 },
          { name: "Lightweight (-70,3 kg)", limit: 70.3 },
          { name: "Welterweight (-77,1 kg)", limit: 77.1 },
          { name: "Middleweight (-83,9 kg)", limit: 83.9 },
          { name: "Light Heavyweight (-93 kg)", limit: 93 },
          { name: "Heavyweight (-120 kg)", limit: 120.2 },
        ],
        Boxing: [
          { name: "Flyweight (-51 kg)", limit: 51 },
          { name: "Featherweight (-57 kg)", limit: 57 },
          { name: "Lightweight (-61 kg)", limit: 61 },
          { name: "Welterweight (-67 kg)", limit: 67 },
          { name: "Middleweight (-73 kg)", limit: 73 },
          { name: "Light Heavyweight (-79 kg)", limit: 79 },
          { name: "Cruiserweight (-90,7 kg)", limit: 90.7 },
          { name: "Heavyweight (+90,7 kg)", limit: 999 },
        ],
        Wrestling: [
          { name: "57 kg", limit: 57 },
          { name: "65 kg", limit: 65 },
          { name: "74 kg", limit: 74 },
          { name: "86 kg", limit: 86 },
          { name: "97 kg", limit: 97 },
          { name: "125 kg", limit: 125 },
        ],
        "Kickboxing / Muay Thai": [
          { name: "60 kg", limit: 60 },
          { name: "67 kg", limit: 67 },
          { name: "71 kg", limit: 71 },
          { name: "75 kg", limit: 75 },
          { name: "81 kg", limit: 81 },
          { name: "86 kg", limit: 86 },
          { name: "91 kg", limit: 91 },
          { name: "+91 kg", limit: 999 },
        ],
        Judo: [
          { name: "60 kg", limit: 60 },
          { name: "66 kg", limit: 66 },
          { name: "73 kg", limit: 73 },
          { name: "81 kg", limit: 81 },
          { name: "90 kg", limit: 90 },
          { name: "100 kg", limit: 100 },
          { name: "+100 kg", limit: 999 },
        ],
      };

      const PHASES = {
        clean: { name: "Kalorienphase", color: "#5c6b3a" },
        lowcarb: { name: "Low-Carb Depletion", color: "#7a5c1a" },
        sodium: { name: "Salz-Reduktion", color: "#1a5a7a" },
        water: { name: "Wasserstrategie", color: "#1a6b6b" },
        cut: { name: "Finaler Cut", color: "#c0281a" },
      };

      const WARNING_THRESHOLDS = {
        same_day: { beginner: 1, intermediate: 3, advanced: 5 },
        day_before: { beginner: 3, intermediate: 8, advanced: 10 },
      };

      // Expert-updated: max % over fight weight 7 days before competition
      const CALORIE_TARGETS_7D = {
        same_day: { beginner: 1, intermediate: 2, advanced: 4 },
        day_before: { beginner: 3, intermediate: 6, advanced: 10 },
      };

      // Expert-updated: realistic % body weight loss per week via calorie cut
      const REALISTIC_WEEKLY_CUT_PCT = {
        beginner: 3,
        intermediate: 3,
        advanced: 4,
      };

      window.addEventListener("DOMContentLoaded", () => {
        populateWeightClasses();
        document
          .getElementById("weightClass")
          .addEventListener("change", saveForm);
        document.querySelectorAll("input, select").forEach((el) => {
          if (el.id !== "weightClass") el.addEventListener("input", saveForm);
        });
        document.getElementById("logDate").value = today();
        document
          .getElementById("currentWeight")
          .addEventListener("input", autoSaveCurrentWeightForToday);
        loadForm();
        setCurrentWeightFromTodayLog();
        renderDailyWeightList();
      });

      let lastTouchEnd = 0;
      document.addEventListener(
        "touchend",
        (event) => {
          const now = Date.now();
          if (now - lastTouchEnd <= 300) event.preventDefault();
          lastTouchEnd = now;
        },
        { passive: false },
      );

      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("./sw.js").catch(() => {});
        });
      }

      function today() {
        return new Date().toISOString().split("T")[0];
      }

      function switchTab(tab, btn) {
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));
        document.getElementById("tab-" + tab).classList.add("active");
        btn.classList.add("active");
      }

      function populateWeightClasses(sport) {
        const s = sport || document.getElementById("sport").value;
        const sel = document.getElementById("weightClass");
        const prev = sel.value;
        sel.innerHTML = '<option value="">- Auswählen -</option>';
        (WEIGHT_CLASSES[s] || []).forEach((w) => {
          const o = document.createElement("option");
          o.value = w.name;
          o.textContent = w.name;
          sel.appendChild(o);
        });
        if (prev) sel.value = prev;
      }

      function onSportChange() {
        populateWeightClasses();
        saveForm();
      }

      function saveForm() {
        localStorage.setItem(
          "wcp_form",
          JSON.stringify({
            sport: document.getElementById("sport").value,
            weightClass: document.getElementById("weightClass").value,
            customLimit: document.getElementById("customLimit").value,
            currentWeight: document.getElementById("currentWeight").value,
            fightDate: document.getElementById("fightDate").value,
            weighInType: document.getElementById("weighInType").value,
            experience: document.getElementById("experience").value,
          }),
        );
      }

      function loadForm() {
        const raw = localStorage.getItem("wcp_form");
        if (!raw) return;
        const d = JSON.parse(raw);
        if (d.sport) {
          document.getElementById("sport").value = d.sport;
          populateWeightClasses(d.sport);
        }
        if (d.weightClass)
          document.getElementById("weightClass").value = d.weightClass;
        if (d.customLimit)
          document.getElementById("customLimit").value = d.customLimit;
        if (d.currentWeight)
          document.getElementById("currentWeight").value = d.currentWeight;
        if (d.fightDate)
          document.getElementById("fightDate").value = d.fightDate;
        if (d.weighInType)
          document.getElementById("weighInType").value = d.weighInType;
        if (d.experience)
          document.getElementById("experience").value = d.experience;
        if (d.currentWeight && d.fightDate) calculate();
      }

      function getDailyWeights() {
        return JSON.parse(localStorage.getItem("wcp_daily_weights") || "{}");
      }
      function saveDailyWeights(weights) {
        localStorage.setItem("wcp_daily_weights", JSON.stringify(weights));
      }

      function saveDailyWeightEntry() {
        const date = document.getElementById("logDate").value;
        const weight = parseFloat(document.getElementById("logWeight").value);
        if (!date || Number.isNaN(weight) || weight <= 0) return;
        const weights = getDailyWeights();
        weights[date] = Number(weight.toFixed(1));
        saveDailyWeights(weights);
        if (date === today()) {
          document.getElementById("currentWeight").value = weight.toFixed(1);
          saveForm();
        }
        document.getElementById("logWeight").value = "";
        renderDailyWeightList();
      }

      function autoSaveCurrentWeightForToday() {
        const weight = parseFloat(
          document.getElementById("currentWeight").value,
        );
        if (Number.isNaN(weight) || weight <= 0) return;
        const weights = getDailyWeights();
        weights[today()] = Number(weight.toFixed(1));
        saveDailyWeights(weights);
        renderDailyWeightList();
      }

      function setCurrentWeightFromTodayLog() {
        const weights = getDailyWeights();
        const w = weights[today()];
        if (w && !document.getElementById("currentWeight").value) {
          document.getElementById("currentWeight").value = Number(w).toFixed(1);
          saveForm();
        }
      }

      function deleteDailyWeightEntry(date) {
        const weights = getDailyWeights();
        delete weights[date];
        saveDailyWeights(weights);
        renderDailyWeightList();
      }

      function renderDailyWeightList() {
        const weights = getDailyWeights();
        const dates = Object.keys(weights).sort((a, b) => b.localeCompare(a));
        const list = document.getElementById("dailyWeightList");
        if (!dates.length) {
          list.innerHTML =
            '<div class="log-meta">Noch keine Einträge gespeichert.</div>';
          return;
        }
        list.innerHTML = dates
          .map(
            (date) => `<div class="log-item">
          <div class="log-meta">${formatDate(date)}</div>
          <div class="log-actions">
            <div class="log-weight">${Number(weights[date]).toFixed(1)} kg</div>
            <button class="btn-small" onclick="deleteDailyWeightEntry('${date}')">Löschen</button>
          </div>
        </div>`,
          )
          .join("");
      }

      // ── EXPERT LOGIC: Check if calorie cut is realistic ──────────────────────────
      function checkCalorieFeasibility(cw, limit, daysUntil, experience) {
        const toCut = Math.max(0, cw - limit);
        if (toCut <= 0)
          return { feasible: true, maxCalorieKg: 0, needsWaterFocus: false };

        const weeklyMaxPct = REALISTIC_WEEKLY_CUT_PCT[experience]; // 3% or 4%
        const weeklyMaxKg = (cw * weeklyMaxPct) / 100;
        const weeksAvailable = daysUntil / 7;
        const maxCalorieKg = weeksAvailable * weeklyMaxKg;

        // Leave at least 2% body weight for water cut (fight week)
        const waterCutBuffer = cw * 0.02;
        const realisticCalorieKg = maxCalorieKg - waterCutBuffer;

        if (toCut > maxCalorieKg) {
          return {
            feasible: false,
            maxCalorieKg: Math.max(0, realisticCalorieKg),
            needsWaterFocus: true,
            excessKg: toCut - maxCalorieKg,
          };
        }
        return {
          feasible: true,
          maxCalorieKg: realisticCalorieKg,
          needsWaterFocus: false,
          excessKg: 0,
        };
      }

      // ── EXPERT LOGIC: Water loading schedule ────────────────────────────────────
      function buildWaterLoadingSchedule(cw, daysUntilWeighIn) {
        const rows = [];
        // 5 days before weigh-in = day (daysUntilWeighIn - 4) if 0-indexed from today
        const schedule = [
          { daysBeforeWeighIn: 5, mlPerKg: 50, label: "5 Tage vor Waage" },
          { daysBeforeWeighIn: 4, mlPerKg: 75, label: "4 Tage vor Waage" },
          { daysBeforeWeighIn: 3, mlPerKg: 100, label: "3 Tage vor Waage" },
          { daysBeforeWeighIn: 2, mlPerKg: 100, label: "2 Tage vor Waage" },
          { daysBeforeWeighIn: 1, mlPerKg: 100, label: "1 Tag vor Waage" },
          {
            daysBeforeWeighIn: 0,
            mlPerKg: null,
            label: "16h vor Waage",
            special: "max. 200 ml gesamt",
          },
        ];
        return schedule.map((s) => ({
          ...s,
          totalMl: s.mlPerKg ? Math.round(cw * s.mlPerKg) : null,
          totalL: s.mlPerKg ? ((cw * s.mlPerKg) / 1000).toFixed(1) : null,
        }));
      }

      // ── NUTRITION PROTOCOL (10 days before fight) ───────────────────────────────
      function buildNutritionProtocol(cw, daysUntil) {
        const days = [];
        for (let d = 10; d >= 1; d--) {
          let carbs,
            protein,
            notes = [];
          if (d === 10) {
            carbs = "Normal (3–5g/kg KG)";
            protein = "min. 2g/kg KG";
            notes = ["Kreatin weglassen"];
          } else if (d >= 8) {
            carbs = "Letzter Tag: 3–5g/kg KG";
            protein = "min. 2g/kg KG";
            notes = ["Kreatin gestoppt"];
          } else if (d >= 7) {
            carbs = "1g/kg KG (vor+nach Training)";
            protein = "min. 2g/kg KG";
            notes = ["Carb-Reduktion beginnt"];
          } else if (d >= 5) {
            carbs = "unter 50g/Tag (vor+nach Training)";
            protein = "min. 2g/kg KG";
            notes = [];
          } else if (d >= 3) {
            carbs = "bis 25g/Tag";
            protein = "min. 2g/kg KG";
            notes = ["Ballaststoffe reduzieren"];
          } else if (d === 2) {
            carbs = "unter 25g";
            protein = "nach Bedarf reduzieren";
            notes = ["Salz weglassen", "Sehr wenig Kohlenhydrate"];
          } else {
            carbs = "minimal";
            protein = "nach Bedarf";
            notes = ["Salz weg", "Wassercut läuft"];
          }

          days.push({ day: d, carbs, protein, notes });
        }
        return days;
      }

      function calculate() {
        saveForm();
        const cw = parseFloat(document.getElementById("currentWeight").value);
        const fightDate = document.getElementById("fightDate").value;
        const customLimit = parseFloat(
          document.getElementById("customLimit").value,
        );
        const weightClass = document.getElementById("weightClass").value;
        const sport = document.getElementById("sport").value;
        const weighInType = document.getElementById("weighInType").value;
        const experience = document.getElementById("experience").value;

        let weightLimit = customLimit || null;
        if (!weightLimit && weightClass) {
          const wc = (WEIGHT_CLASSES[sport] || []).find(
            (w) => w.name === weightClass,
          );
          if (wc) weightLimit = wc.limit;
        }

        const el = document.getElementById("results");
        if (!cw || !weightLimit || !fightDate) {
          el.innerHTML = "";
          return;
        }

        const daysUntil = daysBetween(today(), fightDate);
        if (daysUntil < 0) {
          el.innerHTML =
            '<div class="warn-box">Der Wettkampf liegt in der Vergangenheit.</div>';
          return;
        }

        const toCut = Math.max(0, cw - weightLimit);
        const totalPct = cw > 0 ? (toCut / cw) * 100 : 0;

        const weekTargetOverPct = CALORIE_TARGETS_7D[weighInType][experience];
        const warningThresholdPct = WARNING_THRESHOLDS[weighInType][experience];
        const targetAt7 = weightLimit * (1 + weekTargetOverPct / 100);

        const nutritionDays = Math.max(0, daysUntil - 7);
        const nutritionCutKg =
          nutritionDays > 0 ? Math.max(0, cw - targetAt7) : 0;
        const startFightWeekWeight =
          nutritionDays > 0 ? Math.max(weightLimit, cw - nutritionCutKg) : cw;
        const fightWeekCutKg = Math.max(0, startFightWeekWeight - weightLimit);
        const fightWeekCutPct =
          startFightWeekWeight > 0
            ? (fightWeekCutKg / startFightWeekWeight) * 100
            : 0;

        // EXPERT: Check calorie feasibility
        const feasibility = checkCalorieFeasibility(
          cw,
          weightLimit,
          daysUntil,
          experience,
        );
        const kcalDeficit =
          nutritionDays > 0 && nutritionCutKg > 0
            ? Math.round((nutritionCutKg * 7700) / nutritionDays)
            : 0;

        const waterLoadingRecommended = fightWeekCutPct >= 5;
        const waterSchedule = buildWaterLoadingSchedule(
          cw,
          weighInType === "day_before" ? daysUntil : daysUntil,
        );
        const nutritionProtocol = buildNutritionProtocol(cw, daysUntil);

        const schedule = buildSchedule({
          cw,
          limit: weightLimit,
          daysUntil,
          nutritionDays,
          nutritionCutKg,
          startFightWeekWeight,
          fightWeekCutKg,
          fightWeekCutPct,
          waterLoadingRecommended,
        });

        let html = "";

        // Stats
        html += `<div class="stats-grid">
          ${statCard("Zu schneiden", `${toCut.toFixed(1)}<span class="stat-unit"> kg</span>`, "#c0281a")}
          ${statCard("Gesamt %", `${totalPct.toFixed(1)}<span class="stat-unit"> %</span>`, "#c0281a")}
          ${statCard("Fight Week Cut", `${fightWeekCutPct.toFixed(1)}<span class="stat-unit"> %</span>`, "#1a5a7a")}
          ${statCard("Tage", `${daysUntil}<span class="stat-unit"> bis Kampf</span>`, "#1a1410")}
        </div>`;

        // Risk banner
        html += `<div class="risk-banner" style="border-color:${riskColor(totalPct)}; background:${riskBg(totalPct)};">
          <span class="risk-tag" style="color:${riskColor(totalPct)}">${riskLabel(totalPct)}</span>
          <div>Gesamtcut: ${toCut.toFixed(1)} kg. Entscheidend ist, wie viel davon in der Wettkampfwoche liegt.</div>
        </div>`;

        if (fightWeekCutPct > warningThresholdPct) {
          html += `<div class="warn-box">Warnung (${weighInType === "same_day" ? "Same Day" : "Tag vorher"}): In der Wettkampfwoche sind aktuell ${fightWeekCutPct.toFixed(1)}% geplant. Empfohlene Warnschwelle für ${experienceLabel(experience)}: ${warningThresholdPct.toFixed(1)}%.</div>`;
        }

        // ── EXPERT: Calorie feasibility check ───────────────────────────────────
        if (!feasibility.feasible) {
          const weeklyMaxPct = REALISTIC_WEEKLY_CUT_PCT[experience];
          html += `<div class="risk-banner calorie-warn">
            <span class="risk-tag" style="color:var(--amber)">⚠ Kalorien-Cut unrealistisch</span>
            <div>Bei ${daysUntil} Tagen bis zum Kampf sind realistisch <strong>${feasibility.maxCalorieKg.toFixed(1)} kg</strong> über Kaloriendefizit abbaubar (${weeklyMaxPct}%/Woche für ${experienceLabel(experience)}). 
            Der fehlende Rest von <strong>~${feasibility.excessKg.toFixed(1)} kg</strong> muss über einen Wasser-Cut erfolgen. 
            Plane deinen Wassercut entsprechend ein und nutze die Water Loading Strategie unten.</div>
          </div>`;
        }

        // Calorie info box
        html += `<div class="info-box">
          <strong>Kalorien- vs. Wasser-Cut Empfehlung</strong><br />
          Ziel 7 Tage vor Kampf (${weighInType === "same_day" ? "Same Day" : "Tag vorher"}, ${experienceLabel(experience)}): max. ${weekTargetOverPct}% über Kampfgewicht (${targetAt7.toFixed(1)} kg).<br />
          ${nutritionDays > 0 ? `Für die Ernährungsphase bleiben ${nutritionDays} Tage.` : "Weniger als 7 Tage bis zum Kampf: Fokus auf konservativen Wochen-Cut."}
          ${nutritionDays > 0 && nutritionCutKg > 0 ? `<br />Nötiger Gewichtsverlust über Kalorienphase: ${nutritionCutKg.toFixed(1)} kg (~${kcalDeficit} kcal/Tag Defizit).` : ""}
          ${nutritionDays > 0 && nutritionCutKg <= 0 ? "<br />Du liegst bereits im Zielbereich für die Kalorienphase." : ""}
        </div>`;

        // ── EXPERT: Water Loading Strategy ──────────────────────────────────────
        if (waterLoadingRecommended || fightWeekCutPct >= 3) {
          const warnText = !waterLoadingRecommended
            ? " (optional bei < 5%)"
            : "";
          html += `<div class="water-box">
            <strong>Water Loading Strategie${warnText}</strong> — Wassermenge basierend auf ${cw.toFixed(1)} kg KG
            <table class="water-table">
              <thead><tr><th>Zeitpunkt</th><th>ml/kg KG</th><th>Gesamt</th></tr></thead>
              <tbody>
                ${waterSchedule
                  .map(
                    (row) => `
                <tr class="${row.daysBeforeWeighIn <= 1 ? "highlight-row" : ""}">
                  <td>${row.label}</td>
                  <td>${row.mlPerKg ? row.mlPerKg + " ml/kg" : "—"}</td>
                  <td>${row.totalL ? `<strong>${row.totalL} L</strong> (${row.totalMl} ml)` : `<strong style="color:var(--red)">${row.special}</strong>`}</td>
                </tr>`,
                  )
                  .join("")}
              </tbody>
            </table>
            <div style="margin-top:8px; font-size:12px; color:var(--ink3)">Water Loading funktioniert nur in Kombination mit Natriumreduktion ab Tag 2–3 vor der Waage.</div>
          </div>`;
        }

        // ── EXPERT: Nutrition Protocol (10 Tage) ────────────────────────────────
        if (daysUntil >= 5) {
          const relevantDays = nutritionProtocol.filter(
            (d) => d.day <= Math.min(10, daysUntil),
          );
          html += `<div class="nutrition-box">
            <strong>Ernährungsprotokoll — 10 Tage vor dem Kampf</strong>
            <div class="nutrition-timeline">
              ${relevantDays
                .map(
                  (d) => `
              <div class="nutrition-day-row">
                <div class="nutrition-day-num">${d.day}</div>
                <div class="nutrition-day-content">
                  <span class="nutrition-tag" style="color:var(--blue); border-color:var(--blue)">Carbs: ${d.carbs}</span>
                  <span class="nutrition-tag" style="color:var(--olive); border-color:var(--olive)">Protein: ${d.protein}</span>
                  ${d.notes.map((n) => `<span class="nutrition-tag" style="color:var(--red); border-color:var(--red)">${n}</span>`).join("")}
                </div>
              </div>`,
                )
                .join("")}
            </div>
            <div style="margin-top:8px; font-size:12px; color:var(--ink3)">Tag 1 = Wettkampftag / Waagtag. Protein bleibt bis 2 Tage vor der Waage konstant auf min. 2g/kg KG.</div>
          </div>`;
        }

        // Cut-Plan timeline
        html +=
          '<div class="card"><div class="card-title">Cut-Plan</div><div class="timeline">';
        schedule.forEach((day) => {
          const phase = PHASES[day.phase];
          const label =
            day.daysLeft === 1
              ? weighInType === "day_before"
                ? "WIEGEN"
                : "KAMPF"
              : formatDate(day.date);
          html += `<div class="day-row" style="border-left-color:${phase.color}">
            <div class="day-date">
              <div class="day-label">${label}</div>
              <div class="day-weight" style="color:${phase.color}">${day.target.toFixed(1)}<span class="day-weight-unit"> kg</span></div>
            </div>
            <div class="day-content">
              <div class="day-phase-name" style="color:${phase.color}">${phase.name}</div>
              <div class="day-tips">${day.tips.map((t) => `<span class="tip-tag ${t.type || ""}">${t.text || t}</span>`).join("")}</div>
            </div>
          </div>`;
        });
        html += "</div></div>";

        // Rehydration
        html += `<div class="rehyd-box">
          <strong>Nach dem Wiegen — Rehydrierung</strong><br />
          Elektrolyte + leicht verdauliche Carbs. Flüssigkeit in kleinen Portionen (nicht auf einmal). Schwer verdauliche Mahlzeiten bis kurz vor Kampf vermeiden. Ziel: schrittweise Glykogenspeicher auffüllen ohne GI-Beschwerden.
        </div>`;

        html += `<div class="disclaimer">Diese App ersetzt keine medizinische oder sportliche Fachberatung. Aggressive Weight Cuts können gesundheitliche Risiken darstellen.</div>`;

        el.innerHTML = html;
      }

      function buildSchedule(ctx) {
        const {
          cw,
          limit,
          daysUntil,
          nutritionDays,
          nutritionCutKg,
          startFightWeekWeight,
          fightWeekCutKg,
          waterLoadingRecommended,
        } = ctx;
        if (daysUntil < 1) return [];
        const out = [];

        for (let i = 0; i < daysUntil; i++) {
          const date = new Date();
          date.setDate(date.getDate() + i + 1);
          const dateStr = date.toISOString().split("T")[0];
          const daysLeft = daysUntil - i;

          let target = limit;
          if (daysLeft > 7 && nutritionDays > 0) {
            const preProgress = (i + 1) / nutritionDays;
            target = cw - nutritionCutKg * Math.min(1, preProgress);
          } else {
            const weekDays = Math.min(7, daysUntil);
            const weekIndex = weekDays - daysLeft + 1;
            const weekProgress = Math.max(0, Math.min(1, weekIndex / weekDays));
            target = startFightWeekWeight - fightWeekCutKg * weekProgress;
          }

          let phase = "cut";
          let tips = [];

          // Nutrition protocol integration
          const daysToFight = daysLeft;

          if (daysLeft > 10) {
            phase = "clean";
            tips = [
              { text: "Moderates Kaloriendefizit" },
              { text: "Protein mind. 2g/kg KG" },
              { text: "Normale Salzmenge" },
              { text: "Training wie geplant" },
              { text: "7–9h Schlaf" },
            ];
          } else if (daysLeft === 10) {
            phase = "clean";
            tips = [
              { text: "Kreatin weglassen", type: "highlight" },
              { text: "Protein min. 2g/kg KG" },
              { text: "Carbs: 3–5g/kg KG (letzter voller Tag)" },
            ];
          } else if (daysLeft >= 7) {
            phase = "lowcarb";
            tips = [
              { text: "Carbs schrittweise reduzieren", type: "amber" },
              { text: "Protein min. 2g/kg KG" },
              {
                text:
                  daysLeft >= 8
                    ? "3–5g Carbs/kg → 1g/kg KG"
                    : "1g Carbs/kg KG (vor+nach Training)",
              },
            ];
          } else if (daysLeft >= 5) {
            phase = "lowcarb";
            tips = [
              { text: "unter 50g Carbs/Tag", type: "amber" },
              { text: "Protein min. 2g/kg KG" },
              { text: "Vor + nach Training essen" },
            ];
          } else if (daysLeft >= 3) {
            phase = "sodium";
            tips = [
              { text: "Salzreduktion (2–4 Tage vor Waage)", type: "blue" },
              { text: "Carbs bis 25g/Tag", type: "amber" },
              { text: "Keine Fertigprodukte" },
              {
                text:
                  daysLeft === 3
                    ? "Water Loading: 100ml/kg KG"
                    : "Water Loading aktiv",
                type: "blue",
              },
            ];
          } else if (daysLeft === 2) {
            phase = "water";
            tips = [
              {
                text: waterLoadingRecommended
                  ? "Water Loading: 100ml/kg KG"
                  : "Kein aggressives Water-Loading nötig",
                type: waterLoadingRecommended ? "blue" : "",
              },
              { text: "Salz weglassen", type: "highlight" },
              { text: "unter 25g Carbs", type: "amber" },
              { text: "Protein nach Bedarf reduzieren" },
            ];
          } else {
            phase = "cut";
            tips = [
              {
                text: "Max. 200ml Wasser gesamt (16h vor Waage)",
                type: "highlight",
              },
              { text: "Sauna / Hot Bath nur letzte 24h" },
              { text: "Keine Extremmaßnahmen ohne Betreuung" },
              { text: "Nach Waage sofort Rehydrieren" },
            ];
          }

          out.push({
            date: dateStr,
            daysLeft,
            phase,
            target: Math.max(limit, target),
            tips,
          });
        }
        return out;
      }

      function daysBetween(d1, d2) {
        return Math.ceil((new Date(d2) - new Date(d1)) / 86400000);
      }

      function formatDate(ds) {
        const d = new Date(ds + "T00:00:00");
        return d
          .toLocaleDateString("de-DE", {
            weekday: "short",
            day: "2-digit",
            month: "2-digit",
          })
          .toUpperCase();
      }

      function riskLabel(pct) {
        if (pct <= 3) return "GRUEN";
        if (pct <= 6) return "GELB";
        if (pct <= 10) return "ORANGE";
        return "ROT";
      }
      function riskColor(pct) {
        if (pct <= 3) return "#15803d";
        if (pct <= 6) return "#92400e";
        if (pct <= 10) return "#c2410c";
        return "#b91c1c";
      }
      function riskBg(pct) {
        if (pct <= 3) return "#f0fdf4";
        if (pct <= 6) return "#fffbeb";
        if (pct <= 10) return "#fff7ed";
        return "#fef2f2";
      }
      function statCard(label, value, color) {
        return `<div class="stat-card"><div class="stat-label">${label}</div><div class="stat-value" style="color:${color}">${value}</div></div>`;
      }
      function experienceLabel(experience) {
        if (experience === "beginner") return "Anfänger";
        if (experience === "intermediate") return "Intermediate";
        return "Erfahren";
      }
    </script>
  </body>
</html>
